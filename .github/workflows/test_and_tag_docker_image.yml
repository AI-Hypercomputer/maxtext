# Copyright 2025 Google LLC

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     https://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow will test and tag MaxText Docker image to GCR.
name: Test and Tag MaxText Docker Images

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      test_mode:
        description: "Test mode (tpu-pre-training, tpu-post-training, gpu-pre-training)"
        required: true
        type: string
      image_date:
        required: true
        type: string

permissions:
  contents: read

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        flavor: >-
            ${{ fromJSON('{
              "gpu-pre-training": ["gpu-unit", "gpu-integration"],
              "tpu-post-training": ["post-training-tpu-unit", "post-training-tpu-integration"],
              "tpu-pre-training": ["tpu-unit", "tpu-integration", "cpu-unit"]
            }')[inputs.test_mode] }}
    uses: ./.github/workflows/run_tests_coordinator.yml
    with:
      flavor: ${{ matrix.flavor }}
      base_image: ${{ inputs.image_name }}:${{ inputs.image_date }}-build-${{ github.run_id }}
      is_scheduled_run: true
      maxtext_installed: true

  notebook-test:
    if: inputs.test_mode == 'tpu-post-training'
    uses: ./.github/workflows/run_jupyter_notebooks.yml
    with:
      device_type: tpu
      device_name: v6e-4
      base_image: ${{ inputs.image_name }}:${{ inputs.image_date }}-build-${{ github.run_id }}
      cloud_runner: linux-x86-ct6e-180-4tpu
      maxtext_installed: true
    secrets:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

  tagging:
    needs: [test, notebook-test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      (needs.notebook-test.result == 'success' || needs.notebook-test.result == 'skipped')
    runs-on: ubuntu-latest
    container: google/cloud-sdk:524.0.0
    steps:
      - name: Configure Docker
        run: gcloud auth configure-docker us-docker.pkg.dev,gcr.io -q

      - name: Create Production Tags
        shell: bash
        run: |
          SOURCE_IMAGE="gcr.io/tpu-prod-env-multipod/${{ inputs.image_name }}"
          TEMP_IMG="$SOURCE_IMAGE:${{ inputs.image_date }}-build-${{ github.run_id }}"

          # Validate existence first
          gcloud container images describe "$TEMP_IMG" > /dev/null

          # 1. Date Tag
          gcloud container images add-tag "$TEMP_IMG" "$SOURCE_IMAGE:${{ inputs.image_date }}" --quiet

          # 2. Latest Tag
          gcloud container images add-tag "$TEMP_IMG" "$SOURCE_IMAGE:latest" --quiet

          # 3. Clean up Temporary Tag
          gcloud container images untag "$TEMP_IMG" --quiet