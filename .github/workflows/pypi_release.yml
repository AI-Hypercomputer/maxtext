# Copyright 2025 Google LLC

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     https://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow will build, test and automatically release MaxText package to PyPI using Trusted Publishing (OIDC).

name: Publish MaxText to PyPI

# Triggers when a new "release" is published in the GitHub UI
on:
  release:
    types: [published]

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  release_approval:
    name: Approve Release
    runs-on: ubuntu-latest
    # "release" environment is configured in MaxText repository settings.
    # This environment requires manual approval before proceeding to the next job.
    environment: release
    steps:
    - name: Acknowledge Approval
      run: echo "Release approved, proceeding to build, test and publish MaxText package."

  build_and_test_maxtext_package:
    name: Build and Test MaxText Package
    needs: [release_approval]
    uses: ./.github/workflows/build_and_test_maxtext.yml
      
  publish_maxtext_package_to_pypi:
    name: Publish MaxText package to PyPI
    needs: [build_and_test_maxtext_package]
    runs-on: ubuntu-latest
    environment: release
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Download MaxText wheel
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
      with:
        name: maxtext-wheel
        path: dist/
    - name: Publish MaxText wheel to PyPI
      # Official action for PyPI Trusted Publishing
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist/
