# Copyright 2023â€“2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This workflow builds and pushes MaxText images for both TPU and GPU devices.
# It runs automatically daily at 12am UTC, on Pull Requests, or manually via Workflow Dispatch.

name: Build Images

on:
  schedule:
    # Run the job daily at 12AM UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Specify target device (all, tpu, or gpu)'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - tpu
          - gpu

jobs:
  build:
    name: Build ${{ matrix.device }}-${{ matrix.build_mode }} Image
    runs-on: linux-x86-n2-16-buildkit
    container: google/cloud-sdk:524.0.0

    # Use Github Actions matrix to run image builds in parallel
    strategy:
      fail-fast: false
      matrix:
        include:
          # TPU Image Builds
          - device: tpu
            build_mode: stable
            image_name: maxtext_jax_stable
            dockerfile: ./dependencies/dockerfiles/maxtext_dependencies.Dockerfile
          - device: tpu
            build_mode: nightly
            image_name: maxtext_jax_nightly
            dockerfile: ./dependencies/dockerfiles/maxtext_dependencies.Dockerfile
          # GPU Image Builds
          - device: gpu
            build_mode: stable
            image_name: maxtext_gpu_jax_stable
            dockerfile: ./dependencies/dockerfiles/maxtext_gpu_dependencies.Dockerfile
          - device: gpu
            build_mode: nightly
            image_name: maxtext_gpu_jax_nightly
            dockerfile: ./dependencies/dockerfiles/maxtext_gpu_dependencies.Dockerfile

    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' && (
        github.event.inputs.target_device == 'all' ||
        github.event.inputs.target_device == 'tpu' ||
        github.event.inputs.target_device == 'gpu'
      )

    # Setup for GKE runners per b/412986220#comment82 and b/412986220#comment90
    steps:
      - name: Check if build should run
        id: check
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${GITHUB_EVENT_INPUTS_TARGET_DEVICE}" != "all" && "${GITHUB_EVENT_INPUTS_TARGET_DEVICE}" != "${{ matrix.device }}" ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping build for device: ${{ matrix.device }} in ${{ matrix.build_mode }} mode."
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Building for device: ${{ matrix.device }} in ${{ matrix.build_mode }} mode."
          fi        env:
          GITHUB_EVENT_INPUTS_TARGET_DEVICE: ${{ github.event.inputs.target_device }}        env:
          GITHUB_EVENT_INPUTS_TARGET_DEVICE: ${{ github.event.inputs.target_device }}

      - name: Checkout git repository
        uses: actions/checkout@v5
        if: steps.check.outputs.should_run == 'true'

      - name: Mark git repository as safe
        if: steps.check.outputs.should_run == 'true'
        run: git config --global --add safe.directory ${GITHUB_WORKSPACE}

      - name: Configure Docker
        if: steps.check.outputs.should_run == 'true'
        run: gcloud auth configure-docker us-docker.pkg.dev,gcr.io -q

      - name: Set up Docker BuildX
        uses: docker/setup-buildx-action@v3.11.1
        if: steps.check.outputs.should_run == 'true'
        with:
          driver: remote
          endpoint: tcp://localhost:1234

      # Env variables to be passed to Dockerfile
      - name: Get metadata
        id: vars
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "image_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      # Docker BuildX command config
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        if: steps.check.outputs.should_run == 'true'
        with:
          push: true
          context: .
          file: ${{ matrix.dockerfile }}
          tags: |
            gcr.io/tpu-prod-env-multipod/${{ matrix.image_name }}:maxtext_${{ steps.vars.outputs.commit_hash }}
            gcr.io/tpu-prod-env-multipod/${{ matrix.image_name }}:${{ steps.vars.outputs.image_date }}
            gcr.io/tpu-prod-env-multipod/${{ matrix.image_name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          build-args: |
            DEVICE=${{ matrix.device }}
            MODE=${{ matrix.build_mode }}
            JAX_VERSION=NONE
            LIBTPU_GCS_PATH=NONE
