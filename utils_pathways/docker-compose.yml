# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

services:

  resource_manager:
    image: us-docker.pkg.dev/cloud-tpu-v2-images/pathways/server:latest
    ports:
      - "29001:29001"
      - "29002:29002"
    entrypoint:
      - /usr/pathways/run/cloud_pathways_server_sanitized
      - --server_port=29001
      - --node_type=resource_manager
      - --instance_count=1
      - --gcs_scratch_location=gs://cloud-pathways-staging/tmp
      - --instance_type=tpuv4:2x2x1
    environment:
      - HOST_ADDRESS=resource_manager
      - TPU_SKIP_MDS_QUERY=true


  worker:
    image: us-docker.pkg.dev/cloud-tpu-v2-images/pathways/server:latest
    ports:
      - "29005:29005"
      - "29006:29006"
      - "8471:8471"
      - "8080:8080"
    entrypoint:
      - /usr/pathways/run/cloud_pathways_server_sanitized
      - --alsologtostderr
      - --server_port=29005
      - --resource_manager_address=resource_manager:29001
      - --gcs_scratch_location=gs://cloud-pathways-staging/tmp
    privileged: true
    depends_on:
      - resource_manager


  proxy:
    image: us-docker.pkg.dev/cloud-tpu-v2-images/pathways/proxy_server:latest
    ports:
      - "29008:29008"
    entrypoint:
      - /usr/pathways/run/cloud_proxy_server_sanitized
      - --server_port=29008
      - --resource_manager_address=resource_manager:29001
      - --gcs_scratch_location=gs://cloud-pathways-staging/tmp
    depends_on:
      - worker
      - resource_manager


  maxtext:
    image: ${MAXTEXT_IMAGE}
    privileged: true
    volumes:
      - ../:/deps
    environment:
      - JAX_PLATFORMS=proxy
      - JAX_BACKEND_TARGET=grpc://proxy:29008
    entrypoint: ["bash", "-c"]
    command:
      - ${COMMAND}
    depends_on:
      - proxy
